# D2B-Workshop

> build d2b examples with real data

## 1. Development Environment
To follow this tutorial, you will need the following tools:

- NodeJS and npm: [Download](https://nodejs.org/en/)
- Vue devtools extension for Chrome or Firefox (for the vue.js portion: not necessary, but recommended) [Firefox](https://addons.mozilla.org/en-US/firefox/addon/vue-js-devtools/) / [Chrome](https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd?hl=en)
- A text editor with

## 2. Download The Workshop Project
To get started with this workshop there is a project template already setup. To download the template run the following command:
```bash
$ git clone https://github.com/d2bjs/d2b-workshop.git
```

Then proceed into the directory:
```bash
$ cd d2b-workshop
```

It is not recommended to use this project in production as is. It is only setup with a development webpack environment.  

### File Structure
Most of the workshop code will go into the `src` directory. This directory contains the following folders:

- `data`: containing some sample data sets
- `demo_d2b`: containing index.js and index.html to be used for creating the d2b demo
- `demo_vue_d2b`: containing index.js and index.html to be used for creating the d2b with vue demo
- `index`: containing index.js, index.html, and styles.scss. The index.html file will be used to list links to the demo pages. The index.js and styles.scss files will also be compiled into the demo pages for shared scripts or styles.

### Running The Dev-server
We can take a look at the application that has been generated by starting the webpack-dev-server using the following command:
``` bash
$ npm start
```

This will start a local server on port 8080, so we can take a look at our application at http://localhost:8080. As we develop our application, webpack will detect any changes we make and will automatically reload our webpage for us.

To stop the server simply use `ctrl-c`

### Pre-installed Dependencies
The project template should already have the dependencies listed that you will need for this workshop. You can install them by running:

Our application has almost everything we will need, but there are a couple packages that will need to be installed. To do this will need to declare them in the `package.json` file, so go ahead and open that up and add the following within the `dependencies` object.
``` bash
$ npm install
```

## 3. D2B example: src/demo_d2b
Lets build a demo with just d2b and d3:

### 3.1 Add a Chart Container: index.html
First, we will need to add a <div> container for our chart.

```html
...
<body>

  <h1>Demo D2B</h1>
  <div class="chart"></div>

</body>
```

### 3.2 Importing library modules: index.js
For this example we will need several modules from `d3` and `d2b` let's import those at the top of our index.js file. If you would like to know more about these modules check out the [d3](https://github.com/d3/d3/blob/master/API.md) and [d2b](docs.d2bjs.org) documentation.

```javascript
import { select, csv, scaleTime, extent, nest, mean, format, axisBottom, timeFormat } from 'd3'
import { chartAxis, svgLine, svgArea } from 'd2b'
```

### 3.3 Retrieve Some Data: index.js
Next, let's retrieve some data. For this example we will be working 25,000+ consecutive days of Seattle weather data.

```javascript
...
csv('src/data/seattle_weather.csv', data => {
  console.log(data)
})
```

Now take a look at the data that has been printed to your console.

![](readme_images/console_seattle_data.png)

### 3.4 Format The Data: index.js
Instead of analyzing 25,000 days of data, let's average the data into 365 days.

Add a `getDailyData` function to the bottom of our script:

```javascript
...
function getDailyData (data) {
  // retrieve mm-dd from the DATE column
  data.forEach(d => d.date = d.DATE.slice(-5))

  // get daily mean precipitation and temperatures values
  return nest()
    .key(d => d.date)
    .entries(data.filter(d => d.date !== '02-29'))
    .map(d => {
      return {
        // the chart's x-axis will use javascript Dates, this requires a full date 'yyyy-mm-dd' so we will just use the current year and omit the year in the chart later on
        date: new Date(`2017-${d.key}`),

        // precipitation and temperature should be parsed as a float and then averaged
        precipitation: mean(d.values, v => parseFloat(v.PRCP)),
        tempMin: mean(d.values, v => parseFloat(v.TMIN)),
        tempMax: mean(d.values, v => parseFloat(v.TMAX))
      }
    })
}
```

What this script does is groups each row from our `data` by it's month and day `mm-dd`. Then average the different statistics that we have over all occurrences for each day.

Then we need to call this function after we retrieved our data in the previous step:

```javascript
...
csv('src/data/seattle_weather.csv', data => {
  console.log(data)

  const dailyData = getDailyData(data)
})

function getDailyData (data) {
...
}
```

### 3.5 Configure the d2b Axis Chart: index.js
In this step we will create a function to return the d2b.chartAxis generator. Later on we will configure the axis chart here as well.

```javascript
function getAxisChart () {
  return chartAxis()
}
```

And let's use that in our csv calback.

```javascript
...
csv('src/data/seattle_weather.csv', data => {
  console.log(data)

  const dailyData = getDailyData(data)

  const axisChart = getAxisChart()
})

function getAxisChart (data) {
...
}
```

### 3.6 Build the Axis Chart Data: index.js
Next, we will build the object that the axis chart is expecting. It should be formatted like this:

```javascript
{
  sets: [
    // the first set of graphs
    {
      // the generator for this set's graphs (e.g. svgBar, svgLine, svgArea, ..)
      generators: [...],
      // the graphs for this set
      graphs: [
        {
          // each graph should have a label and a set of values e.g. { x, y }
          label: '...',
          values: [...]
        },
        ...
      ]
    },
    ...
  ]
}
```

So that we keep the logic separated, let's create another function to build the axis chart data. We will pass it the daily weather data. For now we will just render the precipitation, and for the x value we will just use the date index. By using the svgArea and svgLine generators we will get a area chart with an emphasized line.

```javascript
...
function getChartData (data) {
  return {
    sets: [
      {
        generators: [svgArea(), svgLine()],
        graphs: [
          {
            label: 'Precipitation',
            values: data.map((d, i) => {
              return {
                x: i,
                y: d.precipitation
              }
            })
          }
        ]
      }
    ]
  }
}
```

### 3.7 Generate The Chart
We can now use the previously defined `getChartData` function to generate the chart. In order to generate the chart we must use d3 to select the container, set the chart datum, and apply the axisChart generator.

```javascript
...
csv('src/data/seattle_weather.csv', data => {
  console.log(data)

  const dailyData = getDailyData(data)

  const axisChart = getAxisChart()

  // select chart container and set datum
  const chart = select('.chart')
    .datum(getChartData(dailyData))
    .call(axisChart)
})
...
```

Voila! We have an axis chart with Seattle's average daily rainfall.

![](readme_images/axis_chart_1.png)

Now that we have a working chart, try playing around with different graph set generators to see how the chart changes (e.g. svgBar, svgScatter)

### 3.8 Configuring a Date X-Axis: index.js
Now let's do some customization. In order to use a javascript date time we must configure a couple of things:

First let's use the `date` attribute instead of the date index.

```javascript
...
{
  label: 'Precipitation',
  values: data.map(d => {
    return {
      x: d.date,
      y: d.precipitation
    }
  })
}
...
```

Next configure the x-axis on the axis chart. The x axis configuration callback function received the chart datum d, and a set of values as the arguments. The values can be used to dynamically define a scale domain (e.g. [min(values), max(values)]).

```javascript
...
function getAxisChart () {
  const monthFormat = timeFormat('%B')

  return chartAxis()
    .x((d, values) => {
      return {
        axis: axisBottom().tickFormat(monthFormat),
        scale: scaleTime().domain(extent(values))
      }
    })
}
...
```

### 3.9 Configuring Tooltip: index.js

Now we can make sure the tooltip is formatted how we want it.

We can configure the tooltip.title inside the axis chart configuration function. The tooltip title will receive the data rows to be referenced in the tooltip. We can simply print out the day formatted x-value of the first row.
```javascript
...
function getAxisChart () {
  const monthFormat = timeFormat('%B'),
        dayFormat = timeFormat('%B %d')

  return chartAxis()
    .x((d, values) => {
      return {
        axis: axisBottom().tickFormat(monthFormat),
        scale: scaleTime().domain(extent(values))
      }
    })
    .tooltipConfig(tooltip => {
      tooltip.title(rows => dayFormat(rows[0].x))
    })
}
...
```

The tooltip row can be configured in the same place. However, because the row configuration will change for precipitation and temperature graphs we can instead configure it in the graph data:

```javascript
...
function getChartData (data) {
  const numberFormat = format('.2'),
        tempFormat = d => `${numberFormat(d)} F`,
        precipFormat = d => `${numberFormat(d)} Inches`

  return {
    sets: [
      {
        generators: [svgArea(), svgLine()],
        graphs: [
          {
            label: 'Precipitation',
            tooltipConfig: tooltip => {
              tooltip.row(row => precipFormat(row.y))
            },
            values: data.map(d => {
              return {
                x: d.date,
                y: d.precipitation
              }
            })
          }
        ]
      }
    ]
  }
}
...
```

### 3.10 Specifying Graph Colors: index.js

By default d2b uses one of the d3 categorical color scales. We can override this by specifying a graphColor accessor when configuring the axis chart.
```javascript
...
function getAxisChart () {
  ...
    .tooltipConfig(tooltip => {
      tooltip.title(rows => dayFormat(rows[0].x))
    })
    .graphColor(d => d.color)
}
...
```

And then providing a color in the graph data:

```javascript
...
{
  label: 'Precipitation',
  color: '#7FDBFF',
  tooltipConfig: tooltip => {
    tooltip.row(row => precipFormat(row.y))
  },
  values: data.map(d => {
    return {
      x: d.date,
      y: d.precipitation
    }
  })
}
...
```

### 3.11 Responsive Chart: index.js
Let's quickly make the chart responsive. This can be done by listening to the window resize event and reapplying the axis chart generator to the selection.

```javascript
...
csv('src/data/seattle_weather.csv', data => {
  ...
  const chart = select('.chart')
    .datum(getChartData(dailyData))
    .call(axisChart)

  window.addEventListener('resize', function(){
    chart.call(axisChart)
  })
})
...
```

### 3.12 Adding Additional Graphs: index.js
For the temperature graphs we will use a separate graph set, and specify a different y-axis by setting `yType: 'y2'`.

```javascript
...
function getChartData (data) {
  const numberFormat = format('.2'),
        tempFormat = d => `${numberFormat(d)} F`,
        precipFormat = d => `${numberFormat(d)} Inches`

  return {
    sets: [
      ...
      {
        generators: [svgLine()],
        yType: 'y2',
        graphs: [
          {
            label: 'Minimum Temperature',
            yType: 'y2',
            color: '#0074D9',
            tooltipConfig: tooltip => {
              tooltip.row(row => tempFormat(row.y))
            },
            values: data.map(d => {
              return {
                x: d.date,
                y: d.tempMin
              }
            })
          },
          {
            label: 'Maximum Temperature',
            yType: 'y2',
            color: '#FF4136',
            tooltipConfig: tooltip => {
              tooltip.row(row => tempFormat(row.y))
            },
            values: data.map(d => {
              return {
                x: d.date,
                y: d.tempMax
              }
            })
          }
        ]
      }
    ]
  }
}
...
```

By now we should have something like this:

![](readme_images/axis-chart-2.png)

### 3.13 Configure Y-Axes: index.js
Let's add labels and some padding to the y-axes. Again this will go in the axis chart configuration. The `linearPadding` option allows you to pad either extent by a percent of the entire range. Also,  unlike the x-axis configuration we don't need access to the dynamic set of values so we can pass a config object directly, rather than a callback function.

```javascript
function getAxisChart () {
  const monthFormat = timeFormat('%B'),
        dayFormat = timeFormat('%B %d')

  return chartAxis()
    .x((d, values) => {
      return {
        axis: axisBottom().tickFormat(monthFormat),
        scale: scaleTime().domain(extent(values))
      }
    })
    .y({
      label: 'Average Precipitation (Inches)',
      linearPadding: [0, 0.25]
    })
    .y2({
      label: 'Average Temperature (F)',
      linearPadding: [0, 0.25]
    })
    .tooltipConfig(tooltip => {
      tooltip.title(rows => dayFormat(rows[0].x))
    })
    .graphColor(d => d.color)
}
```

### 3.14 Add Annotations: index.js
One of the new features in d2b is the ability to add annotations to an axis chart. These can be done at the chart, graph, or point level. In this example we will add an annotation to the precipitation graph at the maximum value. Learn more about annotations from the [d3-annotation](d3-annotation.susielu.com) documentation.

First let's import the callout circle annotation type at the beginning of the file:
```javascript
...
import { annotationCalloutCircle } from 'd3-svg-annotation'
...
```

Then we can add an annotations array to the precipitation graph:

```javascript
...
{
  label: 'Precipitation',
  color: '#7FDBFF',
  tooltipConfig: tooltip => {
    tooltip.row(row => precipFormat(row.y))
  },
  values: data.map(d => {
    return {
      x: d.date,
      y: d.precipitation
    }
  }),
  annotations: [
    {
      x: new Date('2017-11-19'),
      y: 0.3,
      type: annotationCalloutCircle,
      note: { title: 'Peak Rainfall In November' },
      dx: -100,
      dy: -40,
      subject: {
        radius: 40
      }
    }
  ]
}
...
```
